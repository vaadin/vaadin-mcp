name: Vaadin Docs Ingestion

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      clear_index:
        description: 'Clear existing Pinecone index before processing (complete rebuild)'
        required: false
        default: false
        type: boolean

jobs:
  ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Vaadin docs repository
        uses: actions/cache@v4
        with:
          path: ./packages/1-asciidoc-converter/vaadin-docs
          key: vaadin-docs-${{ inputs.branch || 'latest' }}-${{ github.run_id }}
          restore-keys: |
            vaadin-docs-${{ inputs.branch || 'latest' }}-
            vaadin-docs-

      - name: Install workspace dependencies
        run: bun install

      - name: Build packages
        run: bun run build

      - name: Process Vaadin Documentation (v24 and v25)
        run: |
          echo "Processing Vaadin documentation for v24 and v25"
          echo ""

          # Process v24 first
          VERSION="v24"
          echo "========================================"
          echo "Processing Vaadin $VERSION"
          echo "========================================"

          # v24: clear index if requested, or always clear on first version
          CLEAR_FLAG=""
          if [ "${{ inputs.clear_index }}" = "true" ]; then
            CLEAR_FLAG="--clear"
            echo "ðŸ—‘ï¸ Clear index requested - clearing before v24"
          else
            CLEAR_FLAG="--clear"
            echo "ðŸ—‘ï¸ Clearing index for first version (v24)"
          fi

          # Step 1: Convert AsciiDoc to Markdown (v24)
          echo ""
          echo "ðŸ“„ Step 1: Converting AsciiDoc to Markdown ($VERSION)..."
          cd packages/1-asciidoc-converter
          mkdir -p logs
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

          bun run convert --branch "$VERSION" 2>&1 | tee logs/asciidoc_conversion_${VERSION}_${TIMESTAMP}.log

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::AsciiDoc conversion failed for $VERSION"
            exit 1
          fi
          echo "âœ… AsciiDoc conversion completed for $VERSION"

          # Step 2: Generate Embeddings and Upload to Pinecone (v24)
          echo ""
          echo "ðŸ§  Step 2: Generating embeddings and uploading to Pinecone ($VERSION)..."
          cd ../2-embedding-generator
          mkdir -p logs

          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          PINECONE_API_KEY="${{ secrets.PINECONE_API_KEY }}" \
          PINECONE_INDEX="${{ secrets.PINECONE_INDEX || 'vaadin-docs' }}" \
          bun run generate $CLEAR_FLAG 2>&1 | tee logs/embedding_generation_${VERSION}_${TIMESTAMP}.log

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Embedding generation failed for $VERSION"
            exit 1
          fi
          echo "âœ… Embedding generation completed for $VERSION"

          cd ../..

          # Process v25 second
          VERSION="v25"
          echo ""
          echo "========================================"
          echo "Processing Vaadin $VERSION"
          echo "========================================"
          echo "Preserving v24 data - not clearing index"

          # Step 1: Convert AsciiDoc to Markdown (v25)
          echo ""
          echo "ðŸ“„ Step 1: Converting AsciiDoc to Markdown ($VERSION)..."
          cd packages/1-asciidoc-converter
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

          bun run convert --branch "$VERSION" 2>&1 | tee logs/asciidoc_conversion_${VERSION}_${TIMESTAMP}.log

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::AsciiDoc conversion failed for $VERSION"
            exit 1
          fi
          echo "âœ… AsciiDoc conversion completed for $VERSION"

          # Step 2: Generate Embeddings and Upload to Pinecone (v25)
          echo ""
          echo "ðŸ§  Step 2: Generating embeddings and uploading to Pinecone ($VERSION)..."
          cd ../2-embedding-generator

          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          PINECONE_API_KEY="${{ secrets.PINECONE_API_KEY }}" \
          PINECONE_INDEX="${{ secrets.PINECONE_INDEX || 'vaadin-docs' }}" \
          bun run generate 2>&1 | tee logs/embedding_generation_${VERSION}_${TIMESTAMP}.log

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Embedding generation failed for $VERSION"
            exit 1
          fi
          echo "âœ… Embedding generation completed for $VERSION"

          cd ../..

          echo ""
          echo "========================================"
          echo "âœ… Both v24 and v25 processed successfully"
          echo "========================================"
      
      - name: Upload conversion logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asciidoc-conversion-logs
          path: ./packages/1-asciidoc-converter/logs/
          retention-days: 7
          include-hidden-files: true
      
      - name: Upload embedding logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: embedding-generation-logs
          path: ./packages/2-embedding-generator/logs/
          retention-days: 7
          include-hidden-files: true
      
      - name: Upload markdown artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: converted-markdown
          path: ./packages/1-asciidoc-converter/dist/markdown/
          retention-days: 3
          include-hidden-files: true
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Ingestion Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Versions:** v24, v25" >> $GITHUB_STEP_SUMMARY
          echo "- **Clear Index:** ${{ inputs.clear_index || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Version | AsciiDoc â†’ Markdown | Markdown â†’ Embeddings |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------------|----------------------|" >> $GITHUB_STEP_SUMMARY

          # Check v24
          V24_ASCIIDOC="âŒ Failed"
          V24_EMBEDDING="âŒ Failed"
          if ls ./packages/1-asciidoc-converter/logs/asciidoc_conversion_v24_*.log 1> /dev/null 2>&1; then
            V24_ASCIIDOC="âœ… Completed"
          fi
          if ls ./packages/2-embedding-generator/logs/embedding_generation_v24_*.log 1> /dev/null 2>&1; then
            V24_EMBEDDING="âœ… Completed"
          fi
          echo "| v24 | $V24_ASCIIDOC | $V24_EMBEDDING |" >> $GITHUB_STEP_SUMMARY

          # Check v25
          V25_ASCIIDOC="âŒ Failed"
          V25_EMBEDDING="âŒ Failed"
          if ls ./packages/1-asciidoc-converter/logs/asciidoc_conversion_v25_*.log 1> /dev/null 2>&1; then
            V25_ASCIIDOC="âœ… Completed"
          fi
          if ls ./packages/2-embedding-generator/logs/embedding_generation_v25_*.log 1> /dev/null 2>&1; then
            V25_EMBEDDING="âœ… Completed"
          fi
          echo "| v25 | $V25_ASCIIDOC | $V25_EMBEDDING |" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const clearIndex = '${{ inputs.clear_index || 'false' }}';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Docs Ingestion Failed: ${new Date().toISOString()}`,
              body: `## ðŸš¨ Docs Ingestion Pipeline Failed

              **Details:**
              - Versions: \`v24, v25\`
              - Clear Index: \`${clearIndex}\`
              - Workflow Run: [#${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

              **Next Steps:**
              1. Check the workflow logs for specific error details
              2. Review the uploaded log artifacts
              3. Check which version failed (v24 or v25)
              4. Consider re-running with manual trigger

              **Common Issues:**
              - API rate limits (OpenAI/Pinecone)
              - Network connectivity issues
              - Invalid environment variables
              - Repository access problems
              - Timeout exceeded (both versions take ~60 minutes)
              `
            })
